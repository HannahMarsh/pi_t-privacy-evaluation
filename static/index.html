<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Parameters</title>
    <style>
        .slider-container {
            width: 300px;
            align-items: center;
        }
        .slider-container label {
            width: 70px;
        }
        .slider-container input {
            flex: 1;
        }
        .slider-value {
            width: 40px;
            text-align: center;
        }
        td {
            vertical-align: top;
        }
        table.params {
            margin-left: 20px;
        }
        td.param-label {
            padding-right: 10px;
        }
        td.param-value {
            padding-left: 20px;
        }
        img {
            padding-bottom: 50px;
            padding-left: 50px;
            width: 600px;
        }
        img.probabilities {
            width: 1200px;
        }
        .description {
            font-size: 12px;
            color: rgba(0, 0, 0, 0.57);
            font-style: italic;
        }
    </style>
    <script>
        function updateImageSrc(imageId, fileName) {
            const img = document.getElementById(imageId);
            img.src = fileName + '?t=' + new Date().getTime();
        }
        async function fetchData() {
            const params = new URLSearchParams({
                N: getSliderValue("N"),
                R: getSliderValue("R"),
                ServerLoad: getSliderValue("ServerLoad"),
                L: getSliderValue("L"),
                X: getSliderValue("X"),
                StdDev: getSliderValue("StdDev"),
                Scenario: getSliderValue("Scenario"),
                NumRuns: getSliderValue("NumRuns"),
                NumBuckets: getSliderValue("NumBuckets"),
            });

            const response = await fetch(`/query?${params.toString()}`);
            if (response.ok) {
                const data = await response.json();
                for (const [key, value] of Object.entries(data)) {
                    console.log(key, value);
                    updateImageSrc(key, value);
                }
            } else {
                document.getElementById("results").textContent = "No data found for the given parameters";
            }
        }

        async function populateSliders() {
            const response = await fetch("/expected");
            const expectedValues = await response.json();

            for (const [key, values] of Object.entries(expectedValues)) {

                const datalist = document.getElementById(`${key}-values`);
                if (datalist) {
                    values.forEach((value, index) => {
                        const option = document.createElement("option");
                        option.value = index;
                        option.label = value;
                        datalist.appendChild(option);
                    });
                    // Set the slider min, max, and step based on values
                    const slider = document.getElementById(key);
                    slider.min = 0;
                    slider.max = values.length - 1;
                    if (values.length === 1) {
                        slider.value = 0;
                        slider.disabled = true;
                        slider.classList.add('disabled');
                    } else {
                        if (key === "NumBuckets") {
                            slider.value = Math.floor(((values.length - 1) * 0.4));
                        } else if (key === "NumRuns") {
                            slider.value = values.length - 1; // Set to the last value initially
                        } else if (key === "N") {
                            slider.Value = Math.floor(((values.length - 1) * 0.25));
                        } else if (key === "R" || key === "ServerLoad" || key === "L") {
                            slider.Value = values.length - 1;
                        } else {
                            slider.value = 0; // Set to the first value initially
                        }
                    }
                    document.getElementById(`${key}-value`).textContent = values[slider.value];

                    // if (key !== "ServerLoad") {
                    //     // Display the initial value
                    //     document.getElementById(`${key}-value`).textContent = values[slider.value];
                    // } else {
                    //     let L = parseFloat(getSliderValue("L"));
                    //     let N = parseFloat(getSliderValue("N"));
                    //     let serverLoad = ((N / L) / 3) * parseFloat(values[slider.value])
                    //     document.getElementById(`${key}-value`).textContent = serverLoad.toString();
                    // }
                }

            }

            // // Set the slider min, max, and step based on values
            // const slider = document.getElementById("NumBuckets");
            // slider.min = 5;
            // slider.max = 100;
            // slider.step = 10
            // slider.value = 20; // Set to the first value initially
            //
            // // Display the initial value
            // document.getElementById(`NumBuckets-value`).textContent = slider.value;
        }

        function getSliderValue(sliderId) {
            const slider = document.getElementById(sliderId);
            if (slider) {
                const index = slider.value;
                const datalist = document.getElementById(`${sliderId}-values`);
                if (!datalist || !datalist.options[index] || !datalist.options[index].label) {
                    return slider.value;
                }
                return datalist.options[index].label;
            } else {
                return 0;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            populateSliders().then(() => fetchData()).then(() => {
                document.querySelectorAll("input[type=range]").forEach((slider) => {
                    slider.addEventListener("input", (event) => {
                        document.getElementById(`${event.target.id}-value`).textContent = getSliderValue(event.target.id);
                        fetchData();
                    });
                });
            });
        });
    </script>
</head>
<body>
<h1>Parameter Slider UI</h1>
<table>
    <tr>
        <td>
            <table class="params">
                <tr>
                    <td class="param-label">
                        <label for="N">n:</label><br>
                        <span class="description">(number of nodes)</span>
                    </td>
                    <td>
                        <input type="range" id="N" list="N-values" />
                        <datalist id="N-values"></datalist>
                    </td>
                    <td class="param-value">
                        <span id="N-value" class="slider-value"></span>
                    </td>
                </tr>
                <tr>
                    <td class="param-label">
                        <label for="R">r:</label><br>
                        <span class="description">(number of clients)</span>
                    </td>
                    <td>
                        <input type="range" id="R" list="R-values" />
                        <datalist id="R-values"></datalist>
                    </td>
                    <td class="param-value">
                        <span id="R-value" class="slider-value"></span>
                    </td>
                </tr>
                <tr>
                    <td class="param-label">
                        <label for="ServerLoad">N / n:</label><br>
                        <span class="description">(server load: number of onions processed per node per round)</span>
                    </td>
                    <td>
                        <input type="range" id="ServerLoad" list="ServerLoad-values" />
                        <datalist id="ServerLoad-values"></datalist>
                    </td>
                    <td class="param-value">
                        <span id="ServerLoad-value" class="slider-value"></span>
                    </td>
                </tr>
                <tr>
                    <td class="param-label">
                        <label for="L">L:</label><br>
                        <span class="description">(number of rounds)</span>
                    </td>
                    <td>
                        <input type="range" id="L" list="L-values" />
                        <datalist id="L-values"></datalist>
                    </td>
                    <td class="param-value">
                        <span id="L-value" class="slider-value"></span>
                    </td>
                </tr>
                <tr>
                    <td class="param-label">
                        <label for="NumRuns">NumRuns:</label><br>
                        <span class="description">(number of runs)</span>
                    </td>
                    <td>
                        <input type="range" id="NumRuns" list="NumRuns-values" />
                        <datalist id="NumRuns-values"></datalist>
                    </td>
                    <td class="param-value">
                        <span id="NumRuns-value" class="slider-value"></span>
                    </td>
                </tr>
                <tr>
                    <td class="param-label">
                        <label for="NumBuckets">NumBuckets:</label><br>
                        <span class="description">(number of buckets)</span>
                    </td>
                    <td>
                        <input type="range" id="NumBuckets" list="NumBuckets-values" />
                        <datalist id="NumBuckets-values"></datalist>
                    </td>
                    <td class="param-value">
                        <span id="NumBuckets-value" class="slider-value"></span>
                    </td>
                </tr>
            </table>
        </td>
        <td>
            <table>
                <tr>
                    <td>
                        <img id="probConfidence_img" src="/plots/probConfidence.png" alt=""/>
                    </td>
                    <td>

                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <img id="probabilities_img" class="probabilities" src="/plots/probabilities.png" alt=""/>
                        <br>
                    </td>
                </tr>

            </table>
        </td>
    </tr>
</table>
<div id="results"></div>
</body>
</html>
